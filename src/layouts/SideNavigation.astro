---
import config from "../../config/github-config";
import fetcher from "../utils/fetcher";
import { getName, getPath } from "../utils/string";

import type { PathType, DocType } from "../utils/types";

const pathRes = (await fetcher(
    "https://api.github.com/repos/ekqt/astro-blog/contents",
    config
)) as Array<PathType>;

const paths = pathRes
    .filter((i) => i.type === "dir")
    .map((i) => {
        const { name, path } = i;
        return {
            name: getName(name),
            path: getPath(path),
        };
    });

const docs: Array<DocType> = [];

for (let path of paths) {
    const pathDocRes = (await fetcher(
        `https://api.github.com/repos/ekqt/astro-blog/contents/${path.path}`,
        config
    )) as Array<DocType>;
    const pathDocs: Array<DocType> = pathDocRes.map((i) => {
        const { name, path } = i;
        return {
            name: getName(name),
            path: getPath(path),
        };
    });
    docs.push(...pathDocs);
}
---

<div class="min-w-fit px-12 mx-4 border-r">
    {
        paths.map((path) => (
            <>
                <h3 class="mt-4 first:mt-0 mb-2 font-semibold text-lg">
                    {path.name}
                </h3>
                <ul class="space-y-2 text-slate-500">
                    {docs
                        .filter((doc) =>
                            doc.path.includes(path.path.toLowerCase())
                        )
                        .map((doc) => (
                            <li>
                                <a href={`/${doc.path}`}>{doc.name}</a>
                            </li>
                        ))}
                </ul>
            </>
        ))
    }
</div>
