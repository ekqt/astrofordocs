---
import Layout from "../layouts/Layout.astro";

import sanity from "../lib/sanity-client";
import { allPagesQuery } from "../lib/sanity-queries";
import type { PageType } from "../lib/types";

import parse from "../utils/parse";

export async function getStaticPaths() {
    const pages: Array<PageType> = await sanity.fetch(allPagesQuery);
    return pages.map((page) => {
        return {
            params: { slug: `${page.category.slug}/${page.slug}` },
            props: {
                page,
                title: page.title,
                lastUpdated: page.lastUpdated,
                authors: page.author
                    .map((i) => i.name)
                    .join(", ")
                    .replace(/,\s([^,]+)$/, " and $1"),
                body: page.body,
            },
        };
    });
}

const { title, lastUpdated, authors, body } = Astro.props;
const parsedBody = await parse(body);
---

<Layout title={title}>
    <section>
        <div class="py-2">
            <h1 class="text-2xl font-bold sm:text-3xl lg:text-6xl">
                {title}
            </h1>
            <p class="text-sm my-2 text-slate-500">
                Last updated: {
                    new Intl.DateTimeFormat("en-US", {
                        day: "numeric",
                        month: "long",
                        year: "numeric",
                    }).format(new Date(lastUpdated))
                } by {authors}
            </p>
        </div>
        <article
            aria-label="Post"
            class="prose:slate prose md:max-w-none prose-p:text-justify prose-p:leading-loose prose-li:leading-loose"
            set:html={parsedBody}
        >
        </article>
    </section>
</Layout>
